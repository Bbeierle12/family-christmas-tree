// Gift Map API - Database Schema
// PostgreSQL + Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified Boolean   @default(false) @map("email_verified")
  passwordHash  String?   @map("password_hash")
  displayName   String    @map("display_name")
  avatarUrl     String?   @map("avatar_url")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")
  isActive      Boolean   @default(true) @map("is_active")
  role          String    @default("user") // user, admin

  // Relations
  ownedWorkspaces   Workspace[]       @relation("WorkspaceOwner")
  workspaceMemberships WorkspaceMember[]
  oauthAccounts     OAuthAccount[]
  sessions          Session[]
  giftMapsCreated   GiftMap[]         @relation("GiftMapCreator")
  peopleCreated     Person[]          @relation("PersonCreator")
  giftIdeasCreated  GiftIdea[]        @relation("GiftIdeaCreator")
  giftIdeasPurchased GiftIdea[]       @relation("GiftIdeaPurchaser")
  comments          Comment[]
  notifications     Notification[]
  activityLogs      ActivityLog[]
  uploads           Upload[]
  invitationsSent   WorkspaceMember[] @relation("InvitedBy")

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

model OAuthAccount {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  provider       String    // google, github, apple
  providerUserId String    @map("provider_user_id")
  accessToken    String?   @map("access_token")
  refreshToken   String?   @map("refresh_token")
  expiresAt      DateTime? @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@map("oauth_accounts")
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @unique @map("token_hash")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================================================
// WORKSPACES & PERMISSIONS
// ============================================================================

model Workspace {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  ownerId     String   @map("owner_id")
  settings    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isArchived  Boolean  @default(false) @map("is_archived")

  // Relations
  owner        User              @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members      WorkspaceMember[]
  giftMaps     GiftMap[]
  tags         Tag[]
  activityLogs ActivityLog[]
  uploads      Upload[]

  @@index([ownerId])
  @@index([slug])
  @@index([isArchived])
  @@map("workspaces")
}

model WorkspaceMember {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  userId      String    @map("user_id")
  role        String    @default("viewer") // owner, editor, viewer
  invitedBy   String?   @map("invited_by")
  invitedAt   DateTime  @default(now()) @map("invited_at")
  joinedAt    DateTime? @map("joined_at")
  status      String    @default("pending") // pending, active, declined

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  inviter   User?     @relation("InvitedBy", fields: [invitedBy], references: [id])

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@index([workspaceId, userId, status])
  @@map("workspace_members")
}

// ============================================================================
// GIFT PLANNING
// ============================================================================

model GiftMap {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  title       String
  description String?
  year        Int?
  occasion    String?  // christmas, birthday, anniversary
  settings    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String?  @map("created_by")
  isArchived  Boolean  @default(false) @map("is_archived")

  // Relations
  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator      User?         @relation("GiftMapCreator", fields: [createdBy], references: [id])
  people       Person[]
  edges        Edge[]
  activityLogs ActivityLog[]

  @@index([workspaceId])
  @@index([year])
  @@index([isArchived])
  @@map("gift_maps")
}

model Person {
  id          String   @id @default(uuid())
  giftMapId   String   @map("gift_map_id")
  name        String
  interests   String?
  ageGroup    String?  @map("age_group") // child, teen, adult, senior
  relationship String? // parent, sibling, friend, etc.
  budgetMin   Decimal? @map("budget_min") @db.Decimal(10, 2)
  budgetMax   Decimal? @map("budget_max") @db.Decimal(10, 2)
  notes       String?
  positionX   Float    @default(0) @map("position_x")
  positionY   Float    @default(0) @map("position_y")
  color       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String?  @map("created_by")

  // Relations
  giftMap   GiftMap    @relation(fields: [giftMapId], references: [id], onDelete: Cascade)
  creator   User?      @relation("PersonCreator", fields: [createdBy], references: [id])
  giftIdeas GiftIdea[]

  @@index([giftMapId])
  @@map("people")
}

model GiftIdea {
  id          String    @id @default(uuid())
  personId    String    @map("person_id")
  title       String
  description String?
  notes       String?
  url         String?
  price       Decimal?  @db.Decimal(10, 2)
  currency    String    @default("USD")
  status      String    @default("idea") // idea, considering, decided, purchased, wrapped, given
  priority    Int       @default(0) // 0=normal, 1=high, -1=low
  imageUrl    String?   @map("image_url")
  purchasedAt DateTime? @map("purchased_at")
  purchasedBy String?   @map("purchased_by")
  positionX   Float     @default(0) @map("position_x")
  positionY   Float     @default(0) @map("position_y")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  createdBy   String?   @map("created_by")

  // Relations
  person    Person             @relation(fields: [personId], references: [id], onDelete: Cascade)
  creator   User?              @relation("GiftIdeaCreator", fields: [createdBy], references: [id])
  purchaser User?              @relation("GiftIdeaPurchaser", fields: [purchasedBy], references: [id])
  comments  Comment[]
  tags      GiftIdeaTag[]

  @@index([personId])
  @@index([status])
  @@map("gift_ideas")
}

// ============================================================================
// ORGANIZATION
// ============================================================================

model Tag {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  name        String
  color       String?

  // Relations
  workspace Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  giftIdeas GiftIdeaTag[]

  @@unique([workspaceId, name])
  @@map("tags")
}

model GiftIdeaTag {
  giftIdeaId String @map("gift_idea_id")
  tagId      String @map("tag_id")

  giftIdea GiftIdea @relation(fields: [giftIdeaId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([giftIdeaId, tagId])
  @@map("gift_idea_tags")
}

model Edge {
  id         String   @id @default(uuid())
  giftMapId  String   @map("gift_map_id")
  sourceType String   @map("source_type") // root, person, idea
  sourceId   String   @map("source_id")
  targetType String   @map("target_type")
  targetId   String   @map("target_id")
  label      String?
  style      Json     @default("{}")
  createdAt  DateTime @default(now()) @map("created_at")

  giftMap GiftMap @relation(fields: [giftMapId], references: [id], onDelete: Cascade)

  @@index([giftMapId])
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
  @@map("edges")
}

// ============================================================================
// COLLABORATION
// ============================================================================

model Comment {
  id         String    @id @default(uuid())
  giftIdeaId String    @map("gift_idea_id")
  userId     String    @map("user_id")
  content    String
  parentId   String?   @map("parent_id")
  editedAt   DateTime? @map("edited_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  isDeleted  Boolean   @default(false) @map("is_deleted")

  // Relations
  giftIdea GiftIdea  @relation(fields: [giftIdeaId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  @@index([giftIdeaId])
  @@index([parentId])
  @@map("comments")
}

model Notification {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  type      String    // comment, mention, share, purchase
  title     String
  message   String?
  link      String?
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([readAt])
  @@map("notifications")
}

// ============================================================================
// AUDIT & TRACKING
// ============================================================================

model ActivityLog {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  giftMapId   String?  @map("gift_map_id")
  userId      String?  @map("user_id")
  action      String   // created, updated, deleted, shared
  entityType  String   @map("entity_type") // person, gift_idea, workspace
  entityId    String?  @map("entity_id")
  metadata    Json     @default("{}")
  ipAddress   String?  @map("ip_address")
  createdAt   DateTime @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  giftMap   GiftMap?  @relation(fields: [giftMapId], references: [id], onDelete: SetNull)
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("activity_log")
}

// ============================================================================
// FILE UPLOADS
// ============================================================================

model Upload {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  workspaceId String   @map("workspace_id")
  filename    String
  storageKey  String   @map("storage_key")
  mimeType    String?  @map("mime_type")
  sizeBytes   BigInt?  @map("size_bytes")
  url         String
  createdAt   DateTime @default(now()) @map("created_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@map("uploads")
}
